<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>3-qubit Ising model in PyTorch &#8212; Practical Quantum Computing for Scientists 2022.02.24 alpha documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Archives" href="../../../archives/archives.html" />
    <link rel="prev" title="Hands-on session 9" href="hands-on-9.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html">
          Practical QC for Scientists</a>
        <span class="navbar-text navbar-version pull-left"><b>2022.02.24</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../PHYS437/index.html">437</a></li>
                <li><a href="../../index.html">710</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Contents <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Courses</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../PHYS437/index.html">PHYS 437</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">PHYS 710</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../archives/archives.html">Archives</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../help/index.html">HOWTOs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/IBM_quantum.html">Using IBM quantum Cloud</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This cell is added by sphinx-gallery</span>
<span class="c1"># It can be customized to whatever you like</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="qubit-ising-model-in-pytorch">
<h1>3-qubit Ising model in PyTorch<a class="headerlink" href="#qubit-ising-model-in-pytorch" title="Permalink to this heading">¶</a></h1>
<p>The interacting spins with variable coupling strengths of an <a class="reference external" href="https://en.wikipedia.org/wiki/Ising_model">Ising model</a> can be used to simulate various machine learning concepts like <a class="reference external" href="https://en.wikipedia.org/wiki/Hopfield_network">Hopfield networks</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/Boltzmann_machine">Boltzmann machines</a> (<a class="reference external" href="https://www.springer.com/gp/book/9783319964232">Schuld &amp; Petruccione (2018)</a>). They also closely imitate the underlying mathematics of a subclass of computational problems called <a class="reference external" href="https://en.wikipedia.org/wiki/Quadratic_unconstrained_binary_optimization">Quadratic Unconstrained Binary Optimization (QUBO)</a> problems.</p>
<p>Ising models are commonly encountered in the subject area of adiabatic quantum computing. Quantum annealing algorithms (for example, as performed on a D-wave system) are often used to find low-energy configurations of Ising problems. The optimization landscape of the Ising model is non-convex, which can make finding global minima challenging. In this tutorial, we get a closer look at this phenomenon by applying gradient descent techniques to a toy Ising model.</p>
<section id="pennylane-implementation">
<h2>PennyLane implementation<a class="headerlink" href="#pennylane-implementation" title="Permalink to this heading">¶</a></h2>
<p>This basic tutorial optimizes a 3-qubit Ising model using the PennyLane <code class="docutils literal notranslate"><span class="pre">default.qubit</span></code> device with PyTorch. In the absence of external fields, the Hamiltonian for this system is given by:</p>
<div class="math notranslate nohighlight">
\[H=-\sum_{&lt;i,j&gt;} J_{ij} \sigma_i \sigma_{j},\]</div>
<p>where each spin can be in the +1 or -1 spin state and <span class="math notranslate nohighlight">\(J_{ij}\)</span> are the nearest-neighbour coupling strengths.</p>
<p>For simplicity, the first spin can be assumed to be in the “up” state (+1 eigenstate of Pauli-Z operator) and the coupling matrix can be set to <span class="math notranslate nohighlight">\(J = [1,-1]\)</span>. The rotation angles for the other two spins are then
optimized so that the energy of the system is minimized for the given couplings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">import</span> <span class="nn">pennylane</span> <span class="k">as</span> <span class="nn">qml</span>
<span class="kn">from</span> <span class="nn">pennylane</span> <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
</pre></div>
</div>
</div>
</div>
<p>A three-qubit quantum circuit is initialized to represent the three
spins:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dev</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;default.qubit&quot;</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="nd">@qml</span><span class="o">.</span><span class="n">qnode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span> 
<span class="k">def</span> <span class="nf">circuit</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="c1"># We use the general Rot(phi,theta,omega,wires) single-qubit operation</span>
    <span class="n">qml</span><span class="o">.</span><span class="n">Rot</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">qml</span><span class="o">.</span><span class="n">Rot</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">qml</span><span class="o">.</span><span class="n">expval</span><span class="p">(</span><span class="n">qml</span><span class="o">.</span><span class="n">PauliZ</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>The cost function to be minimized is defined as the energy of the spin
configuration:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">):</span>
    <span class="c1"># the circuit function returns a numpy array of Pauli-Z expectation values</span>
    <span class="n">spins</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">)</span>

    <span class="c1"># the expectation value of Pauli-Z is +1 for spin up and -1 for spin down</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">spins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">spins</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">spins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">spins</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">energy</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="sanity-check">
<h2>Sanity check<a class="headerlink" href="#sanity-check" title="Permalink to this heading">¶</a></h2>
<p>Let’s test the functions above using the
<span class="math notranslate nohighlight">\([s_1, s_2, s_3] = [1, -1, -1]\)</span> spin configuration and the given
coupling matrix. The total energy for this Ising model should be:</p>
<div class="math notranslate nohighlight">
\[H = -1(J_1 s_1 \otimes s_2 + J_2 s_2 \otimes s3) = 2\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">test2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

<span class="n">cost_check</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">test1</span><span class="p">,</span> <span class="n">test2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Energy for [1, -1, -1] spin configuration:&quot;</span><span class="p">,</span> <span class="n">cost_check</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy for [1, -1, -1] spin configuration: tensor(2.0000, dtype=torch.float64)
</pre></div>
</div>
</div>
</div>
</section>
<section id="random-initialization">
<h2>Random initialization<a class="headerlink" href="#random-initialization" title="Permalink to this heading">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">56</span><span class="p">)</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">var_init</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">]</span>
<span class="n">cost_init</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Randomly initialized angles:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Corresponding cost before optimization:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cost_init</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Randomly initialized angles:
tensor([1.9632, 2.6022, 2.3277], dtype=torch.float64, requires_grad=True)
tensor([0.6521, 2.8474, 2.4300], dtype=torch.float64, requires_grad=True)
Corresponding cost before optimization:
tensor(1.6792, dtype=torch.float64, grad_fn=&lt;SubBackward0&gt;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="optimization">
<h2>Optimization<a class="headerlink" href="#optimization" title="Permalink to this heading">¶</a></h2>
<p>Now we use the PyTorch gradient descent optimizer to minimize the cost:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">var_init</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">closure</span><span class="p">():</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="n">var_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_init</span><span class="p">]</span>
<span class="n">cost_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">cost_init</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">closure</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">p1n</span><span class="p">,</span> <span class="n">p2n</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
        <span class="n">costn</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">p1n</span><span class="p">,</span> <span class="n">p2n</span><span class="p">)</span>
        <span class="n">var_pt</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">p1n</span><span class="p">,</span> <span class="n">p2n</span><span class="p">])</span>
        <span class="n">cost_pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">costn</span><span class="p">)</span>

        <span class="c1"># for clarity, the angles are printed as numpy arrays</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Energy after step </span><span class="si">{:5d}</span><span class="s2">: </span><span class="si">{: .7f}</span><span class="s2"> | Angles: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">costn</span><span class="p">,</span> <span class="p">[</span><span class="n">p1n</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">p2n</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]),</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy after step     5:  0.6846474 | Angles: [array([1.96323939, 1.93604492, 2.32767565]), array([0.65212549, 2.73080219, 2.4299563 ])] 

Energy after step    10: -1.0138530 | Angles: [array([1.96323939, 1.0136468 , 2.32767565]), array([0.65212549, 2.73225282, 2.4299563 ])] 

Energy after step    15: -1.8171995 | Angles: [array([1.96323939, 0.38483073, 2.32767565]), array([0.65212549, 2.85992571, 2.4299563 ])] 

Energy after step    20: -1.9686584 | Angles: [array([1.96323939, 0.13026452, 2.32767565]), array([0.65212549, 2.97097572, 2.4299563 ])] 

Energy after step    25: -1.9930403 | Angles: [array([1.96323939, 0.04302756, 2.32767565]), array([0.65212549, 3.04042222, 2.4299563 ])] 

Energy after step    30: -1.9980133 | Angles: [array([1.96323939, 0.01413292, 2.32767565]), array([0.65212549, 3.08179844, 2.4299563 ])] 

Energy after step    35: -1.9993550 | Angles: [array([1.96323939, 0.00463472, 2.32767565]), array([0.65212549, 3.10627578, 2.4299563 ])] 

Energy after step    40: -1.9997802 | Angles: [array([1.96323939e+00, 1.51911413e-03, 2.32767565e+00]), array([0.65212549, 3.12073668, 2.4299563 ])] 

Energy after step    45: -1.9999239 | Angles: [array([1.96323939e+00, 4.97829828e-04, 2.32767565e+00]), array([0.65212549, 3.12927707, 2.4299563 ])] 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy after step    50: -1.9999735 | Angles: [array([1.96323939e+00, 1.63134183e-04, 2.32767565e+00]), array([0.65212549, 3.13432035, 2.4299563 ])] 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy after step    55: -1.9999908 | Angles: [array([1.96323939e+00, 5.34564150e-05, 2.32767565e+00]), array([0.65212549, 3.13729842, 2.4299563 ])] 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy after step    60: -1.9999968 | Angles: [array([1.96323939e+00, 1.75166673e-05, 2.32767565e+00]), array([0.65212549, 3.13905695, 2.4299563 ])] 

Energy after step    65: -1.9999989 | Angles: [array([1.96323939e+00, 5.73986944e-06, 2.32767565e+00]), array([0.65212549, 3.14009534, 2.4299563 ])] 

Energy after step    70: -1.9999996 | Angles: [array([1.96323939e+00, 1.88084132e-06, 2.32767565e+00]), array([0.65212549, 3.14070851, 2.4299563 ])] 

Energy after step    75: -1.9999999 | Angles: [array([1.96323939e+00, 6.16314188e-07, 2.32767565e+00]), array([0.65212549, 3.14107057, 2.4299563 ])] 

Energy after step    80: -2.0000000 | Angles: [array([1.96323939e+00, 2.01953845e-07, 2.32767565e+00]), array([0.65212549, 3.14128437, 2.4299563 ])] 

Energy after step    85: -2.0000000 | Angles: [array([1.96323939e+00, 6.61762372e-08, 2.32767565e+00]), array([0.65212549, 3.14141062, 2.4299563 ])] 

Energy after step    90: -2.0000000 | Angles: [array([1.96323939e+00, 2.16846296e-08, 2.32767565e+00]), array([0.65212549, 3.14148516, 2.4299563 ])] 

Energy after step    95: -2.0000000 | Angles: [array([1.96323939e+00, 7.10561943e-09, 2.32767565e+00]), array([0.65212549, 3.14152918, 2.4299563 ])] 

Energy after step   100: -2.0000000 | Angles: [array([1.96323939e+00, 2.32836938e-09, 2.32767565e+00]), array([0.65212549, 3.14155517, 2.4299563 ])] 
</pre></div>
</div>
</div>
</div>
<p><strong>Note</strong></p>
<p>When using the <em>PyTorch</em> optimizer, keep in mind that:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">loss.backward()</span></code> computes the gradient of the cost function with
respect to all parameters with <code class="docutils literal notranslate"><span class="pre">requires_grad=True</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">opt.step()</span></code> performs the parameter update based on this <em>current</em>
gradient and the learning rate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">opt.zero_grad()</span></code> sets all the gradients back to zero. It’s
important to call this before <code class="docutils literal notranslate"><span class="pre">loss.backward()</span></code> to avoid the
accumulation of gradients from multiple passes.</p></li>
</ol>
<p>Hence, its standard practice to define the <code class="docutils literal notranslate"><span class="pre">closure()</span></code> function that
clears up the old gradient, evaluates the new gradient and passes it
onto the optimizer in each step.</p>
<p>The minimum energy is -2 for the spin configuration <span class="math notranslate nohighlight">\([s_1, s_2, s_3] = [1, 1, -1]\)</span> which corresponds to <span class="math notranslate nohighlight">\((\phi, \theta, \omega) = (0, 0, 0)\)</span> for the second spin and <span class="math notranslate nohighlight">\((\phi, \theta, \omega) = (0, \pi, 0)\)</span> for the third spin. Note that gradient descent optimization might not find this global minimum due to the non-convex cost function, as is shown in the next section.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p1_final</span><span class="p">,</span> <span class="n">p2_final</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimized angles:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p1_final</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p2_final</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final cost after optimization:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cost</span><span class="p">(</span><span class="n">p1_final</span><span class="p">,</span> <span class="n">p2_final</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimized angles:
tensor([1.9632e+00, 2.3284e-09, 2.3277e+00], dtype=torch.float64,
       requires_grad=True)
tensor([0.6521, 3.1416, 2.4300], dtype=torch.float64, requires_grad=True)
Final cost after optimization:
tensor(-2.0000, dtype=torch.float64, grad_fn=&lt;SubBackward0&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Enable processing the Torch trainable tensors</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cost_pt</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;global minimum&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Optimization steps&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cost / Energy&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../_images/813d145c39e1d786ce8f7be9386fac61e42c95a64eab1b18bf012a03bdaf43d5.png" src="../../../../_images/813d145c39e1d786ce8f7be9386fac61e42c95a64eab1b18bf012a03bdaf43d5.png" />
</div>
</div>
</section>
<section id="local-minimum">
<h2>Local minimum<a class="headerlink" href="#local-minimum" title="Permalink to this heading">¶</a></h2>
<p>If the spins are initialized close to the local minimum of zero energy, the optimizer is likely to get stuck here and never find the global minimum at -2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="n">p3</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span> <span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">p4</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span> <span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">var_init_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">]</span>
<span class="n">cost_init_loc</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Corresponding cost before optimization:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cost_init_loc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Corresponding cost before optimization:
tensor(0.0082, dtype=torch.float64, grad_fn=&lt;SubBackward0&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">var_init_loc</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">closure</span><span class="p">():</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="n">var_pt_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_init_loc</span><span class="p">]</span>
<span class="n">cost_pt_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">cost_init_loc</span><span class="p">]</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">closure</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p3n</span><span class="p">,</span> <span class="n">p4n</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
        <span class="n">costn</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">p3n</span><span class="p">,</span> <span class="n">p4n</span><span class="p">)</span>
        <span class="n">var_pt_loc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">p3n</span><span class="p">,</span> <span class="n">p4n</span><span class="p">])</span>
        <span class="n">cost_pt_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">costn</span><span class="p">)</span>

        <span class="c1"># for clarity, the angles are printed as numpy arrays</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Energy after step </span><span class="si">{:5d}</span><span class="s1">: </span><span class="si">{: .7f}</span><span class="s1"> | Angles: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">costn</span><span class="p">,</span> <span class="p">[</span><span class="n">p3n</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">p4n</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]),</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy after step     5:  0.0032761 | Angles: [array([0.77369911, 2.63471297, 1.07981163]), array([0.26038622, 0.08659858, 1.91060734])] 

Energy after step    10:  0.0013137 | Angles: [array([0.77369911, 2.63406019, 1.07981163]), array([0.26038622, 0.05483683, 1.91060734])] 

Energy after step    15:  0.0005266 | Angles: [array([0.77369911, 2.63379816, 1.07981163]), array([0.26038622, 0.03471974, 1.91060734])] 

Energy after step    20:  0.0002111 | Angles: [array([0.77369911, 2.63369307, 1.07981163]), array([0.26038622, 0.02198151, 1.91060734])] 

Energy after step    25:  0.0000846 | Angles: [array([0.77369911, 2.63365094, 1.07981163]), array([0.26038622, 0.01391648, 1.91060734])] 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy after step    30:  0.0000339 | Angles: [array([0.77369911, 2.63363405, 1.07981163]), array([0.26038622, 0.00881044, 1.91060734])] 

Energy after step    35:  0.0000136 | Angles: [array([0.77369911, 2.63362729, 1.07981163]), array([0.26038622, 0.00557782, 1.91060734])] 

Energy after step    40:  0.0000054 | Angles: [array([0.77369911, 2.63362457, 1.07981163]), array([0.26038622, 0.00353126, 1.91060734])] 

Energy after step    45:  0.0000022 | Angles: [array([0.77369911, 2.63362348, 1.07981163]), array([0.26038622, 0.00223561, 1.91060734])] 

Energy after step    50:  0.0000009 | Angles: [array([0.77369911, 2.63362305, 1.07981163]), array([2.60386222e-01, 1.41534339e-03, 1.91060734e+00])] 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy after step    55:  0.0000004 | Angles: [array([0.77369911, 2.63362287, 1.07981163]), array([2.60386222e-01, 8.96040252e-04, 1.91060734e+00])] 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy after step    60:  0.0000001 | Angles: [array([0.77369911, 2.6336228 , 1.07981163]), array([2.60386222e-01, 5.67274421e-04, 1.91060734e+00])] 

Energy after step    65:  0.0000001 | Angles: [array([0.77369911, 2.63362278, 1.07981163]), array([2.60386222e-01, 3.59135947e-04, 1.91060734e+00])] 

Energy after step    70:  0.0000000 | Angles: [array([0.77369911, 2.63362276, 1.07981163]), array([2.60386222e-01, 2.27365491e-04, 1.91060734e+00])] 

Energy after step    75:  0.0000000 | Angles: [array([0.77369911, 2.63362276, 1.07981163]), array([2.60386222e-01, 1.43942891e-04, 1.91060734e+00])] 

Energy after step    80:  0.0000000 | Angles: [array([0.77369911, 2.63362276, 1.07981163]), array([2.60386222e-01, 9.11288509e-05, 1.91060734e+00])] 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Energy after step    85:  0.0000000 | Angles: [array([0.77369911, 2.63362276, 1.07981163]), array([2.60386222e-01, 5.76927932e-05, 1.91060734e+00])] 

Energy after step    90:  0.0000000 | Angles: [array([0.77369911, 2.63362276, 1.07981163]), array([2.60386222e-01, 3.65247488e-05, 1.91060734e+00])] 

Energy after step    95:  0.0000000 | Angles: [array([0.77369911, 2.63362276, 1.07981163]), array([2.60386222e-01, 2.31234648e-05, 1.91060734e+00])] 

Energy after step   100:  0.0000000 | Angles: [array([0.77369911, 2.63362276, 1.07981163]), array([2.60386222e-01, 1.46392417e-05, 1.91060734e+00])] 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Enable processing the Torch trainable tensors</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cost_pt_loc</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;local minimum&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Optimization steps&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cost / Energy&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../_images/fbaf564ef75943463e102b7afb28255703668d3f495417fd0661b00843eca61d.png" src="../../../../_images/fbaf564ef75943463e102b7afb28255703668d3f495417fd0661b00843eca61d.png" />
</div>
</div>
</section>
<section id="send-it-after-class">
<h2>Send it after class |<a class="headerlink" href="#send-it-after-class" title="Permalink to this heading">¶</a></h2>
<p>Try with different initialization parameters and see how the results change.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="two-types-of-quantum-computers">
<h1>Two Types of Quantum Computers<a class="headerlink" href="#two-types-of-quantum-computers" title="Permalink to this heading">¶</a></h1>
<p>It is not well-known what problems quantum computers can solve. We can classify quantum computers into “gate model” and “quantum annealing”. They have different use cases and architecture.</p>
<section id="gate-model">
<h2>Gate Model<a class="headerlink" href="#gate-model" title="Permalink to this heading">¶</a></h2>
<p>The quantum gate model computers are designed for universal purposes by applying gates to build complex algorithms. They can be considered the upward compatible machines of classical computers but exponentially fast if appropriate quantum algorithms like Shor and Grover are used. The applications include prime factorisation, which becomes a threat to the existing secure data transmission methods over the internet using RSA (Rivest–Shamir–Adleman) keys, quantum simulations which have the potential for finding new medicines, and machine learning. However, the gate model requires high-quality qubit processors; the number of qubits is limited to two digits (except for IBM’s exploratory 127-qubit Eagle system.)</p>
</section>
<section id="quantum-annealing">
<h2>Quantum Annealing<a class="headerlink" href="#quantum-annealing" title="Permalink to this heading">¶</a></h2>
<p>On the other hand, quantum annealers shine when they are used to search for the best from a vast number of possible combinations. Such challenges are called combinatorial optimisation problems. Many applications of quantum annealing have been reported recently. There are also researches to develop novel machine learning algorithms using quantum annealers. Amin et al. showed that there were possibilities to use quantum annealing hardware as a sampler for Boltzmann Machine by exploiting its quantum nature.</p>
<p>In physics, the minimum energy principle states that the internal energy decreases and approaches the minimum values. If we can formulate our problems in the form of an energy minimisation equation, the quantum annealer will be able to search for the best possible answer.</p>
<p>Quantum annealer is relatively noise-tolerant compared to the gate model. At the time of this writing, the most considerable number of qubits on a quantum processing unit (QPU) is at least five thousand provided by D-Wave’s Advantage solver. It is expected to increase more in the coming years. Five thousand qubits is a large number compared to what is achieved by the gate model. However, what we obtain from the annealer is as limited as a set of 5k-bit values per sampling. Furthermore, not all qubits are connected. Therefore, a hybrid system of classical computing and the quantum annealer is being developed to complement the capabilities of the two systems.</p>
<p>Annealing is a technique used to make quality iron products by heating the material to a certain degree of temperature and cooling it down slowly. The iron’s mechanical characteristics are altered through the heat treatment, which reduces the hardness and increases the elasticity.</p>
<p>Simulated annealing (SA) is a probabilistic technique whose name and idea are derived from annealing in material science. SA is a meta-heuristic in which algorithms approximate the global minimum or maximum of a given function. It uses a parameter called temperature that is initialised with a high value and decreases as the algorithm proceeds, like the physical annealing. High-temperature value promotes the algorithm to look for the various parts of the problem space, which helps to avoid being stuck in local minima or maxima. When the temperature goes down to zero, the state reaches the optimal point if successful. Going through the SA algorithm is outside the scope of this article, and the details on how it works can be found, for example, on the MathWorks website.</p>
<p>Quantum annealing (QA) is an algorithm to solve combinatorial optimisation problems mainly. Instead of using temperature to explore the problem space, QA uses the laws of quantum mechanics to measure the energy state. Starting from the qubits’ dual state, where all the possible combinations of the values are equally likely to happen, we can gradually reduce such quantum mechanical effects by the process called quantum fluctuation to reach the most optimal point where the lowest energy state is realised.</p>
<p>Kadowaki and Nishimori proved that QA converges to the optimal state with a much larger probability than SA in almost all cases on classical computers. The actual quantum annealing machines were developed by D-Wave and built on the ground of their theoretical framework.</p>
</section>
<section id="formulating-problem-for-qa">
<h2>Formulating Problem for QA<a class="headerlink" href="#formulating-problem-for-qa" title="Permalink to this heading">¶</a></h2>
<p>QA machines are specialised hardware to solve combinatorial optimisation problems. These problems can be found in many places in our life. For example, an Amazon delivery person needs to find the most optimal route to deliver all parcels given for the day. The objective is to find a route with the shortest distance to visit all the delivery addresses. We can treat the distance as the energy in the QA context and find the path that reaches the ground state. We can also think of a futuristic example where multiple autonomous cars are navigated to optimise the traffic in a specific city area with heavy traffic jams. The objective is to reduce the traffic by minimising the number of overlaps of cars taking the same route simultaneously while each car aims to optimise the travel time to a destination.</p>
<p>Quantum annealers require an objective function to be defined in the Ising model or Quadratic Unconstrained Binary Optimisation (QUBO). Ising model is a mathematical model in statistical mechanics. QUBO is mathematically equivalent to the Ising model and is much simpler to formulate a problem.</p>
<p>QUBO is a minimisation objective function expressed as follows:</p>
<div class="math notranslate nohighlight">
\[ H_{QUBO}(x)=\sum_{i=1}^N \sum_{j=1}^N Q_{ij}x_ix_j \]</div>
<p>where <span class="math notranslate nohighlight">\(x_i\)</span> and <span class="math notranslate nohighlight">\(x_j\_ {i,j =0,1,…,N}\)</span> takes 0 or 1. <span class="math notranslate nohighlight">\(Q_{ij}\)</span> is a coefficient matrix of size <span class="math notranslate nohighlight">\(n \times n\)</span>, which we need to prepare for a QA machine. In case of a problem to search for a global maximum, we can flip the sign to minus to convert the problem into a minimisation problem.</p>
<p>In reality, a problem must be satisfied with one or more constraints. For example, a knapsack problem has a constraint of how many weights you can pack things in the bag. Such constraints are multiplied by weight parameters and are added to the objective function as penalty terms.</p>
</section>
<section id="implementation-using-quantum-annealer">
<h2>Implementation Using Quantum Annealer<a class="headerlink" href="#implementation-using-quantum-annealer" title="Permalink to this heading">¶</a></h2>
<p>In this section, we would like to code and solve a simple combinatorial optimisation problem in Python and the real Quantum Annealer by D-Wave.</p>
</section>
<section id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this heading">¶</a></h2>
<p>Before starting, we need to sign up for a cloud computing service. D-wave offers trial access to QA solvers with a sixty-second computational time allowance for one month. Please go to D-Wave Leap to find out more. After successful registration, the API token is available on the dashboard.</p>
</section>
<section id="problem-setting">
<h2>Problem Setting<a class="headerlink" href="#problem-setting" title="Permalink to this heading">¶</a></h2>
<p>We would like to challenge a simplified portfolio optimisation problem. Suppose there are twenty candidate stocks from FTSE100 to invest in. Our objective is to maximise an expected return rate at the minimum risk while keeping more or less ten stocks in our portfolio.</p>
<p>We will take the following six steps to solve the problem:</p>
<ol class="arabic simple">
<li><p>Import historical stock price data from the internet</p></li>
<li><p>Prepare data by cleansing and feature engineering</p></li>
<li><p>Formulate the cost functions and constraints to obtain a QUBO matrix</p></li>
<li><p>Sample optimisation results from a D-Wave solver</p></li>
<li><p>Sample optimisation results from a simulated quantum annealing solver</p></li>
<li><p>Evaluate the outcomes</p></li>
</ol>
<p>Each of the above steps is demonstrated in a Colab notebook found in Python Coding in Colab Notebook section.</p>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">¶</a></h2>
<p>Some notes on the Python requirements:</p>
<ul class="simple">
<li><p>yfinance is used to retrieve stock price data from Yahoo! Finance.</p></li>
<li><p>Prophet is a python package used to make time-series forecasting. It is possible to do multivariate time series forecasting and add holiday effects easily.</p></li>
<li><p>D-Wave Ocean SDK needs to be installed. The SDK includes packages that are necessary to communicate with D-Wave resources.</p></li>
<li><p>PyQUBO is a library that can construct QUBO from cost and constraints functions.</p></li>
<li><p>OpenJIJ is an open-source meta-heuristics library for the Ising model and QUBO. It simulates the quantum annealers and can be used to experiment without the D-Wave computers. It accepts QUBOs stored in a Python dictionary type.</p></li>
</ul>
</section>
<section id="cost-and-constraint-function">
<h2>Cost and Constraint Function<a class="headerlink" href="#cost-and-constraint-function" title="Permalink to this heading">¶</a></h2>
<p>Our objective in this example is to minimise the sum of two cost functions and one constraint term, namely:</p>
<ol class="arabic simple">
<li><p>the maximisation of return rates</p></li>
<li><p>the minimisation of risks by lowering portfolio variance</p></li>
<li><p>the minimisation of the penalty term</p></li>
<li><p>The maximisation of the return rates can be formulated as a minimisation cost function:</p></li>
</ol>
<div class="math notranslate nohighlight" id="equation-cost-function-1">
<span class="eqno">(1)<a class="headerlink" href="#equation-cost-function-1" title="Permalink to this equation">¶</a></span>\[ H_{cost1}=-\sum_{i=1}^N R_ix_i \]</div>
<p>where <span class="math notranslate nohighlight">\(R_i\)</span> is the return rate of the <span class="math notranslate nohighlight">\(i\)</span>th stock <span class="math notranslate nohighlight">\(x_i\)</span>. Because <span class="math notranslate nohighlight">\(x_i\)</span> only takes a binary value <span class="math notranslate nohighlight">\(0\)</span> or <span class="math notranslate nohighlight">\(1\)</span>, <span class="math notranslate nohighlight">\(x_i\)</span> is equivalent with the quadratic term <span class="math notranslate nohighlight">\(x_i \times x_i\)</span>. Therefore, <span class="math notranslate nohighlight">\(H_{cost1}\)</span> function can be equivalent to the following QUBO:</p>
<div class="math notranslate nohighlight" id="equation-cost-function-as-qubo">
<span class="eqno">(2)<a class="headerlink" href="#equation-cost-function-as-qubo" title="Permalink to this equation">¶</a></span>\[ H_{cost1_{QUBO}} = -\sum_{i=j\, i,j=1}^NR_{ij}x_ix_j \]</div>
<ol class="arabic simple" start="2">
<li><p>The minimisation of portfolio variance is represented as :</p></li>
</ol>
<div class="math notranslate nohighlight" id="equation-cost-function-2">
<span class="eqno">(3)<a class="headerlink" href="#equation-cost-function-2" title="Permalink to this equation">¶</a></span>\[ H_{cost2}=\sum_{i=1}^N\sum_{j=1}^NW_{ij}x_ix_j \]</div>
<p>where W denotes a covariance matrix.</p>
<ol class="arabic simple" start="3">
<li><p>The minimisation of the penalty can be formed in mean squared error (MSE) as a constraint term:</p></li>
</ol>
<div class="math notranslate nohighlight" id="equation-constraint-term">
<span class="eqno">(4)<a class="headerlink" href="#equation-constraint-term" title="Permalink to this equation">¶</a></span>\[ H_{const}=(\sum_{i=1}^N x_i- K)^2 \]</div>
<p>where K is the number of stocks to be selected for the portfolio.</p>
<p><span class="math notranslate nohighlight">\(H_{const}\)</span> can also be transformed to the equivalent QUBOs by expanding the formula:</p>
<div class="math notranslate nohighlight">
\[\begin{split} H_{const}=(\sum_{i=1}^N x_i- K)^2\\ =(\sum_{i=1}^N x_i- K)(\sum_{j=1}^N x_j- K)\\=\sum_{i,j=1}^N x_ix_j-2K\sum_{i=1}^Nx_i + K^2 \end{split}\]</div>
<p>(Constraint term expanded for QUBO formulation)</p>
<p><span class="math notranslate nohighlight">\(-2K\sum_{i=1}^Nx_i\)</span> part can also be equivalent to the quadratic form, as seen in the above <span class="math notranslate nohighlight">\(H_{cost1}\)</span> function. <span class="math notranslate nohighlight">\(K^2\)</span> is a constant value called offset which is not included in the QUBO matrix.</p>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">PyQUBO</span></code> library in Python code to generate the QUBO matrix from functions for simplicity.</p>
<p>Thus, we can solve the problem by finding such x that minimises the function H(x) = (H_cost1 + H_cost2 + lambda*H_const), where lambda is a weight parameter for the constraint</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="import-historical-stock-price-data-from-the-internet">
<h1>1. Import historical stock price data from the internet<a class="headerlink" href="#import-historical-stock-price-data-from-the-internet" title="Permalink to this heading">¶</a></h1>
<p>First of all, Install Yahoo finance library to retrieve stock data.
We will import randomly selected 20 stocks from FTSE100 and extract the historical closing prices for the past 2 years from July 2020.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install yfinance
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/bin/bash: /home/obm/Prog/miniconda3/envs/qml/lib/libtinfo.so.6: no version information available (required by /bin/bash)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: yfinance in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (0.2.3)
Requirement already satisfied: numpy&gt;=1.16.5 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (1.23.4)
Requirement already satisfied: lxml&gt;=4.9.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (4.9.2)
Requirement already satisfied: frozendict&gt;=2.3.4 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (2.3.4)
Requirement already satisfied: beautifulsoup4&gt;=4.11.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (4.11.1)
Requirement already satisfied: pandas&gt;=1.3.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (1.5.1)
Requirement already satisfied: pytz&gt;=2022.5 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (2022.7)
Requirement already satisfied: appdirs&gt;=1.4.4 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (1.4.4)
Requirement already satisfied: multitasking&gt;=0.0.7 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (0.0.11)
Requirement already satisfied: html5lib&gt;=1.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (1.1)
Requirement already satisfied: cryptography&gt;=3.3.2 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (37.0.1)
Requirement already satisfied: requests&gt;=2.26 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from yfinance) (2.28.1)
Requirement already satisfied: soupsieve&gt;1.2 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from beautifulsoup4&gt;=4.11.1-&gt;yfinance) (2.3.1)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: cffi&gt;=1.12 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from cryptography&gt;=3.3.2-&gt;yfinance) (1.15.1)
Requirement already satisfied: webencodings in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from html5lib&gt;=1.1-&gt;yfinance) (0.5.1)
Requirement already satisfied: six&gt;=1.9 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from html5lib&gt;=1.1-&gt;yfinance) (1.16.0)
Requirement already satisfied: python-dateutil&gt;=2.8.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from pandas&gt;=1.3.0-&gt;yfinance) (2.8.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from requests&gt;=2.26-&gt;yfinance) (3.4)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from requests&gt;=2.26-&gt;yfinance) (2022.9.24)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from requests&gt;=2.26-&gt;yfinance) (1.26.12)
Requirement already satisfied: charset-normalizer&lt;3,&gt;=2 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from requests&gt;=2.26-&gt;yfinance) (2.1.1)
Requirement already satisfied: pycparser in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from cffi&gt;=1.12-&gt;cryptography&gt;=3.3.2-&gt;yfinance) (2.21)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> A new release of pip available: <span class=" -Color -Color-Red">22.3</span> -&gt; <span class=" -Color -Color-Green">22.3.1</span>
<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> To update, run: <span class=" -Color -Color-Green">pip install --upgrade pip</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>  
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># list of FTSE100 stocks available at </span>
<span class="c1"># https://www.londonstockexchange.com/indices/ftse-100/constituents/table</span>
<span class="c1"># below are randomly selected stocks</span>

<span class="n">stocks_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;FLTR.L&#39;</span><span class="p">:</span><span class="s1">&#39;FLUTTER ENTERTAINMENT PLC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SVT.L&#39;</span><span class="p">:</span><span class="s1">&#39;SEVERN TRENT PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;LSEG.L&#39;</span><span class="p">:</span><span class="s1">&#39;LONDON STOCK EXCHANGE GROUP PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;BNZL.L&#39;</span><span class="p">:</span><span class="s1">&#39;BUNZL PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;CPG.L&#39;</span><span class="p">:</span><span class="s1">&#39;COMPASS GROUP PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;NXT.L&#39;</span><span class="p">:</span><span class="s1">&#39;NEXT PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;ULVR.L&#39;</span><span class="p">:</span><span class="s1">&#39;UNILEVER PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;SHEL.L&#39;</span><span class="p">:</span><span class="s1">&#39;SHELL PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;CCH.L&#39;</span><span class="p">:</span><span class="s1">&#39;COCA-COLA HBC A&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;BRBY.L&#39;</span><span class="p">:</span><span class="s1">&#39;BURBERRY GROUP PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;SSE.L&#39;</span><span class="p">:</span><span class="s1">&#39;SSE PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;REL.L&#39;</span><span class="p">:</span><span class="s1">&#39;RELX PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;EXPN.L&#39;</span><span class="p">:</span><span class="s1">&#39;EXPERIAN PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;DCC.L&#39;</span><span class="p">:</span><span class="s1">&#39;DCC PLC ORD&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;AZN.L&#39;</span><span class="p">:</span><span class="s1">&#39;ASTRAZENECA PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;GSK.L&#39;</span><span class="p">:</span><span class="s1">&#39;GSK PLC ORD&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;ADM.L&#39;</span><span class="p">:</span><span class="s1">&#39;ADMIRAL GROUP PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;SDR.L&#39;</span><span class="p">:</span><span class="s1">&#39;SCHRODERS PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;BATS.L&#39;</span><span class="p">:</span><span class="s1">&#39;BRITISH AMERICAN TOBACCO PLC&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;IHG.L&#39;</span><span class="p">:</span><span class="s1">&#39;INTERCONTINENTAL HOTELS GROUP PLC&#39;</span><span class="p">,</span> 
    <span class="p">}</span>
    
<span class="n">stocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stocks_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># list of candidate stocks</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span><span class="s1">&#39;2020-07-01&#39;</span><span class="p">,</span><span class="s1">&#39;2022-04-30&#39;</span><span class="p">)[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="c1"># main data</span>
<span class="n">data_test</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span><span class="s1">&#39;2022-05-01&#39;</span><span class="p">,</span><span class="s1">&#39;2022-07-24&#39;</span><span class="p">)[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="c1"># testing data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[                       0%                       ]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*****                 10%                       ]  2 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*******               15%                       ]  3 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*******               15%                       ]  3 of 20 completed
[*******               15%                       ]  3 of 20 completed
[*******               15%                       ]  3 of 20 completed
[*****************     35%                       ]  7 of 20 completed
[*****************     35%                       ]  7 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*****************     35%                       ]  7 of 20 completed
[**********************50%                       ]  10 of 20 completed
[**********************50%                       ]  10 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************60%****                   ]  12 of 20 completed
[**********************60%****                   ]  12 of 20 completed
[**********************60%****                   ]  12 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************75%***********            ]  15 of 20 completed
[**********************75%***********            ]  15 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************85%****************       ]  17 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************90%******************     ]  18 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************95%*********************  ]  19 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  20 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[                       0%                       ]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*****                 10%                       ]  2 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*****                 10%                       ]  2 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********            20%                       ]  4 of 20 completed
[**********            20%                       ]  4 of 20 completed
[**********            20%                       ]  4 of 20 completed
[**********            20%                       ]  4 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*******************   40%                       ]  8 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************45%                       ]  9 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************45%                       ]  9 of 20 completed
[**********************45%                       ]  9 of 20 completed
[**********************60%****                   ]  12 of 20 completed
[**********************60%****                   ]  12 of 20 completed
[**********************60%****                   ]  12 of 20 completed
[**********************60%****                   ]  12 of 20 completed
[**********************60%****                   ]  12 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************85%****************       ]  17 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************90%******************     ]  18 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[**********************95%*********************  ]  19 of 20 completed
[*********************100%***********************]  20 of 20 completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ADM.L</th>
      <th>AZN.L</th>
      <th>BATS.L</th>
      <th>BNZL.L</th>
      <th>BRBY.L</th>
      <th>CCH.L</th>
      <th>CPG.L</th>
      <th>DCC.L</th>
      <th>EXPN.L</th>
      <th>FLTR.L</th>
      <th>GSK.L</th>
      <th>IHG.L</th>
      <th>LSEG.L</th>
      <th>NXT.L</th>
      <th>REL.L</th>
      <th>SDR.L</th>
      <th>SHEL.L</th>
      <th>SSE.L</th>
      <th>SVT.L</th>
      <th>ULVR.L</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>464.000000</td>
      <td>464.000000</td>
      <td>463.000000</td>
      <td>464.000000</td>
      <td>464.000000</td>
      <td>464.000000</td>
      <td>463.000000</td>
      <td>463.000000</td>
      <td>463.000000</td>
      <td>464.000000</td>
      <td>464.000000</td>
      <td>463.000000</td>
      <td>464.000000</td>
      <td>464.000000</td>
      <td>464.000000</td>
      <td>464.000000</td>
      <td>463.000000</td>
      <td>464.000000</td>
      <td>464.000000</td>
      <td>464.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2949.351293</td>
      <td>8366.258621</td>
      <td>2787.561555</td>
      <td>2537.961207</td>
      <td>1804.203375</td>
      <td>2294.758621</td>
      <td>1466.997840</td>
      <td>6042.596112</td>
      <td>2933.794816</td>
      <td>12754.031149</td>
      <td>1475.618385</td>
      <td>4722.868251</td>
      <td>7975.392241</td>
      <td>7204.778017</td>
      <td>1997.713362</td>
      <td>568.022027</td>
      <td>1489.860042</td>
      <td>1503.168103</td>
      <td>2601.586207</td>
      <td>4142.657884</td>
    </tr>
    <tr>
      <th>std</th>
      <td>298.590229</td>
      <td>753.326915</td>
      <td>223.859266</td>
      <td>228.969271</td>
      <td>228.739954</td>
      <td>314.297710</td>
      <td>176.851449</td>
      <td>420.743959</td>
      <td>288.931273</td>
      <td>2003.651264</td>
      <td>128.447452</td>
      <td>399.235132</td>
      <td>794.814741</td>
      <td>952.486937</td>
      <td>248.250476</td>
      <td>52.854523</td>
      <td>299.833511</td>
      <td>144.853407</td>
      <td>241.375319</td>
      <td>357.982299</td>
    </tr>
    <tr>
      <th>min</th>
      <td>2240.000000</td>
      <td>6794.000000</td>
      <td>2448.000000</td>
      <td>2131.000000</td>
      <td>1252.500000</td>
      <td>1460.500000</td>
      <td>1050.500000</td>
      <td>5006.000000</td>
      <td>2273.000000</td>
      <td>7922.000000</td>
      <td>1199.561523</td>
      <td>3516.000000</td>
      <td>6370.000000</td>
      <td>4673.000000</td>
      <td>1527.500000</td>
      <td>442.510010</td>
      <td>900.000000</td>
      <td>1171.000000</td>
      <td>2168.000000</td>
      <td>3328.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2756.750000</td>
      <td>7931.500000</td>
      <td>2643.750000</td>
      <td>2363.000000</td>
      <td>1630.000000</td>
      <td>2073.000000</td>
      <td>1393.250000</td>
      <td>5785.000000</td>
      <td>2738.000000</td>
      <td>11400.000000</td>
      <td>1385.821991</td>
      <td>4549.000000</td>
      <td>7371.500000</td>
      <td>6282.000000</td>
      <td>1788.625000</td>
      <td>519.009995</td>
      <td>1333.299988</td>
      <td>1384.875000</td>
      <td>2413.250000</td>
      <td>3911.125000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>2962.000000</td>
      <td>8413.000000</td>
      <td>2734.000000</td>
      <td>2479.500000</td>
      <td>1820.250000</td>
      <td>2372.500000</td>
      <td>1497.500000</td>
      <td>6030.000000</td>
      <td>2893.000000</td>
      <td>12890.000000</td>
      <td>1446.565674</td>
      <td>4812.000000</td>
      <td>7939.000000</td>
      <td>7660.000000</td>
      <td>1918.250000</td>
      <td>587.179993</td>
      <td>1440.400024</td>
      <td>1524.250000</td>
      <td>2511.000000</td>
      <td>4124.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>3116.250000</td>
      <td>8678.250000</td>
      <td>2825.750000</td>
      <td>2712.750000</td>
      <td>1965.250000</td>
      <td>2532.250000</td>
      <td>1586.250000</td>
      <td>6268.000000</td>
      <td>3109.000000</td>
      <td>14282.500000</td>
      <td>1579.234680</td>
      <td>5026.000000</td>
      <td>8596.000000</td>
      <td>7980.500000</td>
      <td>2227.250000</td>
      <td>606.942520</td>
      <td>1660.300049</td>
      <td>1612.000000</td>
      <td>2823.000000</td>
      <td>4358.500000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3688.000000</td>
      <td>10930.000000</td>
      <td>3439.000000</td>
      <td>3163.000000</td>
      <td>2264.000000</td>
      <td>2784.000000</td>
      <td>1820.500000</td>
      <td>7204.000000</td>
      <td>3667.000000</td>
      <td>16915.000000</td>
      <td>1823.720459</td>
      <td>5338.000000</td>
      <td>9910.000000</td>
      <td>8426.000000</td>
      <td>2449.000000</td>
      <td>658.070007</td>
      <td>2228.000000</td>
      <td>1868.500000</td>
      <td>3211.000000</td>
      <td>4892.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_test</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ADM.L</th>
      <th>AZN.L</th>
      <th>BATS.L</th>
      <th>BNZL.L</th>
      <th>BRBY.L</th>
      <th>CCH.L</th>
      <th>CPG.L</th>
      <th>DCC.L</th>
      <th>EXPN.L</th>
      <th>FLTR.L</th>
      <th>GSK.L</th>
      <th>IHG.L</th>
      <th>LSEG.L</th>
      <th>NXT.L</th>
      <th>REL.L</th>
      <th>SDR.L</th>
      <th>SHEL.L</th>
      <th>SSE.L</th>
      <th>SVT.L</th>
      <th>ULVR.L</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
      <td>57.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2185.973684</td>
      <td>10508.228070</td>
      <td>3466.447368</td>
      <td>2814.035088</td>
      <td>1629.964912</td>
      <td>1777.026316</td>
      <td>1710.345614</td>
      <td>5494.614035</td>
      <td>2555.052632</td>
      <td>8403.048070</td>
      <td>1758.225729</td>
      <td>4650.421053</td>
      <td>7403.684211</td>
      <td>6209.087719</td>
      <td>2244.596491</td>
      <td>471.872281</td>
      <td>2205.994736</td>
      <td>1753.149123</td>
      <td>2853.773158</td>
      <td>3699.675439</td>
    </tr>
    <tr>
      <th>std</th>
      <td>173.503948</td>
      <td>403.405858</td>
      <td>81.319788</td>
      <td>146.057225</td>
      <td>60.288581</td>
      <td>101.134432</td>
      <td>237.407090</td>
      <td>409.703802</td>
      <td>152.041397</td>
      <td>1243.157730</td>
      <td>34.193845</td>
      <td>256.656103</td>
      <td>264.537545</td>
      <td>239.741846</td>
      <td>75.721260</td>
      <td>16.497939</td>
      <td>148.555222</td>
      <td>89.980502</td>
      <td>401.790333</td>
      <td>129.866329</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1729.000000</td>
      <td>9750.000000</td>
      <td>3300.000000</td>
      <td>2575.000000</td>
      <td>1482.000000</td>
      <td>1548.000000</td>
      <td>16.700001</td>
      <td>4889.000000</td>
      <td>2285.000000</td>
      <td>81.739998</td>
      <td>1684.302124</td>
      <td>4193.000000</td>
      <td>6738.000000</td>
      <td>5764.000000</td>
      <td>2081.000000</td>
      <td>438.260010</td>
      <td>1936.400024</td>
      <td>1587.500000</td>
      <td>28.070000</td>
      <td>3451.500000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2157.000000</td>
      <td>10244.000000</td>
      <td>3426.000000</td>
      <td>2671.000000</td>
      <td>1586.000000</td>
      <td>1712.000000</td>
      <td>1691.500000</td>
      <td>5162.000000</td>
      <td>2424.000000</td>
      <td>8200.000000</td>
      <td>1732.252319</td>
      <td>4404.000000</td>
      <td>7220.000000</td>
      <td>5986.000000</td>
      <td>2210.000000</td>
      <td>458.320007</td>
      <td>2044.000000</td>
      <td>1677.500000</td>
      <td>2794.000000</td>
      <td>3609.500000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>2228.000000</td>
      <td>10506.000000</td>
      <td>3478.000000</td>
      <td>2837.000000</td>
      <td>1636.500000</td>
      <td>1775.500000</td>
      <td>1730.000000</td>
      <td>5308.000000</td>
      <td>2578.000000</td>
      <td>8468.000000</td>
      <td>1758.242188</td>
      <td>4695.000000</td>
      <td>7390.000000</td>
      <td>6148.000000</td>
      <td>2265.000000</td>
      <td>469.200012</td>
      <td>2225.000000</td>
      <td>1761.000000</td>
      <td>2872.000000</td>
      <td>3690.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2267.000000</td>
      <td>10800.000000</td>
      <td>3528.500000</td>
      <td>2919.000000</td>
      <td>1678.500000</td>
      <td>1837.500000</td>
      <td>1796.500000</td>
      <td>5710.000000</td>
      <td>2661.000000</td>
      <td>8944.000000</td>
      <td>1783.400024</td>
      <td>4841.000000</td>
      <td>7632.000000</td>
      <td>6428.000000</td>
      <td>2299.000000</td>
      <td>486.200012</td>
      <td>2338.000000</td>
      <td>1821.000000</td>
      <td>2996.000000</td>
      <td>3802.500000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2561.000000</td>
      <td>11232.000000</td>
      <td>3628.000000</td>
      <td>3108.000000</td>
      <td>1743.000000</td>
      <td>1945.500000</td>
      <td>1854.000000</td>
      <td>6268.000000</td>
      <td>2835.000000</td>
      <td>9760.000000</td>
      <td>1815.863037</td>
      <td>5150.000000</td>
      <td>7894.000000</td>
      <td>6686.000000</td>
      <td>2375.000000</td>
      <td>505.239990</td>
      <td>2440.000000</td>
      <td>1920.000000</td>
      <td>3148.000000</td>
      <td>3943.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="prepare-data-by-cleansing-and-feature-engineering">
<h1>2. Prepare data by cleansing and feature engineering<a class="headerlink" href="#prepare-data-by-cleansing-and-feature-engineering" title="Permalink to this heading">¶</a></h1>
<p>Check null values. We will drop a row with null in this example for simplicity  but please cosnider replacing the values if possible.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="c1"># null row for each stock</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ADM.L     0
AZN.L     0
BATS.L    1
BNZL.L    0
BRBY.L    0
CCH.L     0
CPG.L     1
DCC.L     1
EXPN.L    1
FLTR.L    0
GSK.L     0
IHG.L     1
LSEG.L    0
NXT.L     0
REL.L     0
SDR.L     0
SHEL.L    1
SSE.L     0
SVT.L     0
ULVR.L    0
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_test</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># check for test data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ADM.L     0
AZN.L     0
BATS.L    0
BNZL.L    0
BRBY.L    0
CCH.L     0
CPG.L     0
DCC.L     0
EXPN.L    0
FLTR.L    0
GSK.L     0
IHG.L     0
LSEG.L    0
NXT.L     0
REL.L     0
SDR.L     0
SHEL.L    0
SSE.L     0
SVT.L     0
ULVR.L    0
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># drop the rows</span>
<span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(459, 20)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_test</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(57, 20)
</pre></div>
</div>
</div>
</div>
<section id="feature-engineering">
<h2>Feature Engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this heading">¶</a></h2>
<p>To make prediction, we use Prophet. See more at https://facebook.github.io/prophet/</p>
<p>We make time series prediction based on the historical data between July 2020 and April 2022. The period to predict is May 2022 till late July 2022, which is the same period of the data in test set.</p>
<p>The predicted values are transformed to be the average return rate for each stock. We can use it for one of the objectives to maximise the sum of return rates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install prophet
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/bin/bash: /home/obm/Prog/miniconda3/envs/qml/lib/libtinfo.so.6: no version information available (required by /bin/bash)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: prophet in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (1.1.1)
Requirement already satisfied: pandas&gt;=1.0.4 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (1.5.1)
Requirement already satisfied: python-dateutil&gt;=2.8.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (2.8.2)
Requirement already satisfied: cmdstanpy&gt;=1.0.4 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (1.0.8)
Requirement already satisfied: LunarCalendar&gt;=0.0.9 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (0.0.9)
Requirement already satisfied: wheel&gt;=0.37.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (0.37.1)
Requirement already satisfied: holidays&gt;=0.14.2 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (0.17.2)
Requirement already satisfied: tqdm&gt;=4.36.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (4.64.1)
Requirement already satisfied: numpy&gt;=1.15.4 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (1.23.4)
Requirement already satisfied: matplotlib&gt;=2.0.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (3.6.0)
Requirement already satisfied: setuptools-git&gt;=1.2 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (1.2)
Requirement already satisfied: setuptools&gt;=42 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (63.4.1)
Requirement already satisfied: convertdate&gt;=2.1.2 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from prophet) (2.4.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: pymeeus&lt;=1,&gt;=0.3.13 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from convertdate&gt;=2.1.2-&gt;prophet) (0.5.12)
Requirement already satisfied: korean-lunar-calendar in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from holidays&gt;=0.14.2-&gt;prophet) (0.3.1)
Requirement already satisfied: hijri-converter in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from holidays&gt;=0.14.2-&gt;prophet) (2.2.4)
Requirement already satisfied: pytz in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from LunarCalendar&gt;=0.0.9-&gt;prophet) (2022.7)
Requirement already satisfied: ephem&gt;=3.7.5.3 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from LunarCalendar&gt;=0.0.9-&gt;prophet) (4.1.4)
Requirement already satisfied: pillow&gt;=6.2.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from matplotlib&gt;=2.0.0-&gt;prophet) (9.2.0)
Requirement already satisfied: kiwisolver&gt;=1.0.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from matplotlib&gt;=2.0.0-&gt;prophet) (1.4.4)
Requirement already satisfied: pyparsing&gt;=2.2.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from matplotlib&gt;=2.0.0-&gt;prophet) (3.0.9)
Requirement already satisfied: packaging&gt;=20.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from matplotlib&gt;=2.0.0-&gt;prophet) (21.3)
Requirement already satisfied: fonttools&gt;=4.22.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from matplotlib&gt;=2.0.0-&gt;prophet) (4.37.4)
Requirement already satisfied: cycler&gt;=0.10 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from matplotlib&gt;=2.0.0-&gt;prophet) (0.11.0)
Requirement already satisfied: contourpy&gt;=1.0.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from matplotlib&gt;=2.0.0-&gt;prophet) (1.0.5)
Requirement already satisfied: six&gt;=1.5 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from python-dateutil&gt;=2.8.0-&gt;prophet) (1.16.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> A new release of pip available: <span class=" -Color -Color-Red">22.3</span> -&gt; <span class=" -Color -Color-Green">22.3.1</span>
<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> To update, run: <span class=" -Color -Color-Green">pip install --upgrade pip</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">prophet</span> <span class="kn">import</span> <span class="n">Prophet</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ERROR:prophet.plot:Importing plotly failed. Interactive plots will not work.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_return_rate</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pred_return_rate_mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># current index of stock</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># number of candidate stocks</span>
<span class="n">periods</span> <span class="o">=</span> <span class="n">data_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># number of days to forecast, same as data_test length</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> <span class="c1"># for each stock</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">()</span>
  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="c1"># index values (dates) as ds </span>
  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="c1"># stock close price as y</span>
  <span class="n">stock_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="c1"># training data</span>
  <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span>
  <span class="n">future</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="n">periods</span><span class="p">)</span> <span class="c1"># predict </span>
  <span class="n">forecast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="c1"># predicted values stored in yhat column</span>
  <span class="n">return_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forecast</span><span class="p">))</span> <span class="c1"># return rate to be stored in numpy array</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
    <span class="n">return_rate</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">forecast</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">forecast</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="c1"># calculate the return rate per day</span>
  <span class="n">pred_return_rate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_rate</span><span class="p">)</span>
  <span class="n">pred_return_rate_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">return_rate</span><span class="p">))</span> <span class="c1"># predicted mean return rate for the stock</span>
  <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/skex3r5n.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/8eglu_aj.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=23638&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/skex3r5n.json&#39;, &#39;init=/tmp/tmpe07d9yq5/8eglu_aj.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelg0zqix38/prophet_model-20221222121631.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:31 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:31 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/052ut3s8.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/swzcijw4.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=17686&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/052ut3s8.json&#39;, &#39;init=/tmp/tmpe07d9yq5/swzcijw4.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modely5g46xyq/prophet_model-20221222121632.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:32 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:32 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/es1uny16.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/63bplu6q.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=91517&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/es1uny16.json&#39;, &#39;init=/tmp/tmpe07d9yq5/63bplu6q.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelwnhpvk3_/prophet_model-20221222121632.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:32 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:32 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/cylm8696.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/kk03bnzs.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=81409&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/cylm8696.json&#39;, &#39;init=/tmp/tmpe07d9yq5/kk03bnzs.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelexnjnl_m/prophet_model-20221222121632.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:32 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:32 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/vd8s_xnk.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/n8j7f_dd.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=10998&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/vd8s_xnk.json&#39;, &#39;init=/tmp/tmpe07d9yq5/n8j7f_dd.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modeld0xvxd8y/prophet_model-20221222121633.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:33 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:33 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/ry7mprqi.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/ybvjqwrf.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=61378&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/ry7mprqi.json&#39;, &#39;init=/tmp/tmpe07d9yq5/ybvjqwrf.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelrg_q5vmx/prophet_model-20221222121633.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:33 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:33 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/ig23xk22.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/qdw_gm1u.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=88980&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/ig23xk22.json&#39;, &#39;init=/tmp/tmpe07d9yq5/qdw_gm1u.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelnvhx7wuy/prophet_model-20221222121633.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:33 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:33 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/ekpsf0b4.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/ksxnhchk.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=60911&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/ekpsf0b4.json&#39;, &#39;init=/tmp/tmpe07d9yq5/ksxnhchk.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modely39vk739/prophet_model-20221222121634.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:34 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:34 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/0qmul04z.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/sdeq5y5b.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=55767&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/0qmul04z.json&#39;, &#39;init=/tmp/tmpe07d9yq5/sdeq5y5b.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modeldixoqs6p/prophet_model-20221222121634.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:34 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:34 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/bzppo40u.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/nii8lkpy.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=55520&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/bzppo40u.json&#39;, &#39;init=/tmp/tmpe07d9yq5/nii8lkpy.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelu5mxui7g/prophet_model-20221222121634.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:34 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:35 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/ol16hhgg.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/pb5krrj0.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=79316&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/ol16hhgg.json&#39;, &#39;init=/tmp/tmpe07d9yq5/pb5krrj0.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelahv6j1e7/prophet_model-20221222121635.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:35 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:35 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/y16zipx0.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/f9n1f9ih.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=6867&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/y16zipx0.json&#39;, &#39;init=/tmp/tmpe07d9yq5/f9n1f9ih.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modela9i6besj/prophet_model-20221222121635.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:35 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:35 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/6fk9spa1.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/17u09qm5.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=53221&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/6fk9spa1.json&#39;, &#39;init=/tmp/tmpe07d9yq5/17u09qm5.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_model4kbc_lsk/prophet_model-20221222121636.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:36 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:36 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/60_ptvjz.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/rno5elri.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=34168&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/60_ptvjz.json&#39;, &#39;init=/tmp/tmpe07d9yq5/rno5elri.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelf5gv4e98/prophet_model-20221222121636.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:36 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:36 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/qpnqpham.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/ghjrsror.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=45374&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/qpnqpham.json&#39;, &#39;init=/tmp/tmpe07d9yq5/ghjrsror.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelktys17lh/prophet_model-20221222121636.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:36 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:36 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/brmnv4l1.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/68kjgs0t.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=51331&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/brmnv4l1.json&#39;, &#39;init=/tmp/tmpe07d9yq5/68kjgs0t.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelss6xg87a/prophet_model-20221222121637.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:37 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:37 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/xpzy2i_b.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/bo_t_qas.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=39935&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/xpzy2i_b.json&#39;, &#39;init=/tmp/tmpe07d9yq5/bo_t_qas.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelfn0km4gm/prophet_model-20221222121637.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:37 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:37 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/smatzxr6.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/lklye49q.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=63219&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/smatzxr6.json&#39;, &#39;init=/tmp/tmpe07d9yq5/lklye49q.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_model3vq_aokf/prophet_model-20221222121637.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:37 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:37 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/7ah9njlh.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/6zojv1br.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=2477&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/7ah9njlh.json&#39;, &#39;init=/tmp/tmpe07d9yq5/6zojv1br.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modelvwnz2hcl/prophet_model-20221222121638.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:38 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:38 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling yearly seasonality. Run prophet with yearly_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:prophet:Disabling daily seasonality. Run prophet with daily_seasonality=True to override this.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/to_oa922.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:input tempfile: /tmp/tmpe07d9yq5/2hnnidxp.json
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:idx 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:running CmdStan, num_threads: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEBUG:cmdstanpy:CmdStan args: [&#39;/home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/prophet/stan_model/prophet_model.bin&#39;, &#39;random&#39;, &#39;seed=42296&#39;, &#39;data&#39;, &#39;file=/tmp/tmpe07d9yq5/to_oa922.json&#39;, &#39;init=/tmp/tmpe07d9yq5/2hnnidxp.json&#39;, &#39;output&#39;, &#39;file=/tmp/tmpe07d9yq5/prophet_modele4gx5s0x/prophet_model-20221222121638.csv&#39;, &#39;method=optimize&#39;, &#39;algorithm=lbfgs&#39;, &#39;iter=10000&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:38 - cmdstanpy - INFO - Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] start processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:16:38 - cmdstanpy - INFO - Chain [1] done processing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:cmdstanpy:Chain [1] done processing
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pred_return_rate_mean</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-3.295120211693522e-05, 0.0004212352164733634, 0.0006443323333763341, 0.0006180876152479546, 0.0005054489754747284, -0.0011332381597290778, 0.0009594389542370872, -0.0004696525374264205, -0.0002568726047600979, -0.0010414517228963223, 0.00016392271944240828, 0.0006151834219843348, -9.028002715718702e-05, -6.64373367560175e-05, 0.0005966905208675229, -0.00019014641894963337, 0.0011606326569417041, 0.0005490521838582731, 0.0004985535894805963, -0.0005879920495425485]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_return_rate_mean</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00014317780640250334
</pre></div>
</div>
</div>
</div>
<p>We also calculate actual return rates from the historical stock price data. We will use the results for the calculation of covariance that will be used for the second objective function to reduce the risk by diversify the portfolio items to avoid losing it altogether.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">actual_return_rate</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">actual_return_rate_mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># number of candidate stocks</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> <span class="c1"># for each stock</span>
  <span class="n">stock_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
  <span class="n">return_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stock_data</span><span class="p">))</span> <span class="c1"># return rate to be stored in numpy array</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
    <span class="n">return_rate</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">stock_data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">stock_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="c1"># calculate the return rate per day</span>
  <span class="n">actual_return_rate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_rate</span><span class="p">)</span>
  <span class="n">actual_return_rate_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">return_rate</span><span class="p">))</span> <span class="c1"># predicted mean return rate for the stock</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">actual_return_rate_mean_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">actual_return_rate_mean</span><span class="p">)</span>
<span class="n">actual_return_rate_mean_mean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00039797518633514584
</pre></div>
</div>
</div>
</div>
<p>Finally, we calculate the actual return rates on the test set for the final evaluation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">actual_return_rate_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">actual_return_rate_mean_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># number of candidate stocks</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> <span class="c1"># for each stock</span>
  <span class="n">stock_data</span> <span class="o">=</span> <span class="n">data_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
  <span class="n">return_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stock_data</span><span class="p">))</span> <span class="c1"># return rate to be stored in numpy array</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
    <span class="n">return_rate</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">stock_data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">stock_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="c1"># calculate the return rate per day</span>
  <span class="n">actual_return_rate_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_rate</span><span class="p">)</span>
  <span class="n">actual_return_rate_mean_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">return_rate</span><span class="p">))</span> <span class="c1"># predicted mean return rate for the stock</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">actual_return_rate_mean_mean_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">actual_return_rate_mean_test</span><span class="p">)</span>
<span class="n">actual_return_rate_mean_mean_test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.26481830738480705
</pre></div>
</div>
</div>
</div>
<p>#3. Formulate the cost functions and constraints to obtain a QUBO matrix</p>
</section>
<section id="constraint-terms">
<h2>Constraint Terms<a class="headerlink" href="#constraint-terms" title="Permalink to this heading">¶</a></h2>
<p>In our portfolio optimisation example, let’s assume 1 constraint: the number of stock to be included in the portfolio.</p>
<p>In this example, we will use PyQubo, a python library that that can conver the cost function to a quadratic unconstraintbinary optimisation matrix that can be sent to D-wave qunatum annealer and JIJ simulated quantum annealer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install pyqubo # https://pyqubo.readthedocs.io/en/latest/index.html
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/bin/bash: /home/obm/Prog/miniconda3/envs/qml/lib/libtinfo.so.6: no version information available (required by /bin/bash)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: pyqubo in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (1.3.1)
Requirement already satisfied: dimod&lt;0.13,&gt;=0.9.14 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from pyqubo) (0.12.3)
Requirement already satisfied: Deprecated&gt;=1.2.12 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from pyqubo) (1.2.13)
Requirement already satisfied: six&gt;=1.15.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from pyqubo) (1.16.0)
Requirement already satisfied: dwave-neal&gt;=0.5.7 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from pyqubo) (0.6.0)
Requirement already satisfied: numpy&gt;=1.17.3 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from pyqubo) (1.23.4)
Requirement already satisfied: wrapt&lt;2,&gt;=1.10 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from Deprecated&gt;=1.2.12-&gt;pyqubo) (1.14.1)
Requirement already satisfied: dwave-samplers&lt;2.0.0,&gt;=1.0.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-neal&gt;=0.5.7-&gt;pyqubo) (1.0.0)
Requirement already satisfied: networkx&gt;=2.4.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-samplers&lt;2.0.0,&gt;=1.0.0-&gt;dwave-neal&gt;=0.5.7-&gt;pyqubo) (2.8.7)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> A new release of pip available: <span class=" -Color -Color-Red">22.3</span> -&gt; <span class=" -Color -Color-Green">22.3.1</span>
<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> To update, run: <span class=" -Color -Color-Green">pip install --upgrade pip</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyqubo</span> <span class="kn">import</span> <span class="n">Array</span><span class="p">,</span> <span class="n">Constraint</span><span class="p">,</span> <span class="n">Placeholder</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">vartype</span><span class="o">=</span><span class="s1">&#39;BINARY&#39;</span><span class="p">)</span> <span class="c1"># array takes binary 0 or 1 indicate to exclude or include a stock in the portfolio, which we need to optimise</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of stocks constraint</span>
<span class="n">num_stocks</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># specify the desired number of stocks</span>
<span class="n">h_const1</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_stocks</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="c1"># MSE from the budget. This lead to x values that makes the portfolio as close as the budget</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cost-functions">
<h2>Cost Functions<a class="headerlink" href="#cost-functions" title="Permalink to this heading">¶</a></h2>
<p>We have set two cost functions to optimise our portfolio. One is to maximise the sum of predicted growth rates that we predicted in the feature engineering section. Another is to minimise the covariance between each of the stock items to be selected in the portfolio. We then add up two cost functions for QUBO.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cost function 1 to aim the highest return</span>
<span class="n">h_cost1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">h_cost1</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pred_return_rate_mean</span><span class="p">)</span> <span class="c1"># maximisation problem. negative to make it minimisation problem</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cost function 2 to balance the portfolio not to put all eggs in one basket</span>
<span class="c1"># minimising the sum of covariance leads to the safer choice</span>
<span class="n">h_cost2</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">h_cost2</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">actual_return_rate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">actual_return_rate</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">actual_return_rate</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h_cost</span> <span class="o">=</span> <span class="n">h_cost1</span> <span class="o">+</span> <span class="n">h_cost2</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="prepare-qubo">
<h2>Prepare QUBO<a class="headerlink" href="#prepare-qubo" title="Permalink to this heading">¶</a></h2>
<p>The problme formulation and representation in QUBO format are habled by PyQubo applications. In the lines below, we compile the model using the objective function that needs to be minimised, then define the constraint coefficient. to_qubo function generates a QUBO matrix in the dictionary type and an offset value which is an costanct value not required for the search for the minimum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h</span> <span class="o">=</span> <span class="n">h_cost</span> <span class="o">+</span> <span class="n">Placeholder</span><span class="p">(</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span><span class="o">*</span><span class="n">Constraint</span><span class="p">(</span><span class="n">h_const1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;num_stocks&#39;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;l1&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="n">qubo</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to_qubo</span><span class="p">(</span><span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">offset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>200.0
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="sample-optimisation-results-from-a-d-wave-solver">
<h1>4. Sample optimisation results from a D-Wave solver<a class="headerlink" href="#sample-optimisation-results-from-a-d-wave-solver" title="Permalink to this heading">¶</a></h1>
<p>Install D-Wave’s Ocean SDK to request the computation to the quantum annealer. EmbeddingComposite is used to embed the QUBO to the physical quantum anneler in D-Wave.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install dwave-ocean-sdk # https://docs.ocean.dwavesys.com/en/stable/
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/bin/bash: /home/obm/Prog/miniconda3/envs/qml/lib/libtinfo.so.6: no version information available (required by /bin/bash)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: dwave-ocean-sdk in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (6.1.1)
Requirement already satisfied: minorminer==0.2.9 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.2.9)
Requirement already satisfied: dwave-tabu==0.5.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.5.0)
Requirement already satisfied: dwave-samplers==1.0.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (1.0.0)
Requirement already satisfied: dwave-preprocessing==0.5.3 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.5.3)
Requirement already satisfied: dimod==0.12.3 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.12.3)
Requirement already satisfied: dwavebinarycsp==0.2.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.2.0)
Requirement already satisfied: dwave-inspector==0.3.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.3.0)
Requirement already satisfied: penaltymodel==1.0.2 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (1.0.2)
Requirement already satisfied: dwave-system==1.18.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (1.18.0)
Requirement already satisfied: pyqubo==1.3.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (1.3.1)
Requirement already satisfied: dwave-greedy==0.3.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.3.0)
Requirement already satisfied: dwave-hybrid==0.6.9 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.6.9)
Requirement already satisfied: dwave-neal==0.6.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.6.0)
Requirement already satisfied: dwave-cloud-client==0.10.3 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.10.3)
Requirement already satisfied: dwave-networkx==0.8.12 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-ocean-sdk) (0.8.12)
Requirement already satisfied: numpy&lt;2.0.0,&gt;=1.17.3 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dimod==0.12.3-&gt;dwave-ocean-sdk) (1.23.4)
Requirement already satisfied: homebase&gt;=1.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (1.0.1)
Requirement already satisfied: pydantic&gt;=1.7.3 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (1.10.2)
Requirement already satisfied: diskcache&gt;=5.2.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (5.4.0)
Requirement already satisfied: requests[socks]&gt;=2.18 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (2.28.1)
Requirement already satisfied: python-dateutil&gt;=2.7 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (2.8.2)
Requirement already satisfied: plucky&gt;=0.4.3 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (0.4.3)
Requirement already satisfied: click&gt;=7.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (8.1.3)
Requirement already satisfied: networkx in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-hybrid==0.6.9-&gt;dwave-ocean-sdk) (2.8.7)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: importlib-resources&gt;=3.2.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-inspector==0.3.0-&gt;dwave-ocean-sdk) (5.2.0)
Requirement already satisfied: Flask&gt;=1.1.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-inspector==0.3.0-&gt;dwave-ocean-sdk) (2.2.2)
Requirement already satisfied: scipy&gt;=1.7.3 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from dwave-system==1.18.0-&gt;dwave-ocean-sdk) (1.9.3)
Requirement already satisfied: fasteners in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from minorminer==0.2.9-&gt;dwave-ocean-sdk) (0.18)
Requirement already satisfied: rectangle-packer&gt;=2.0.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from minorminer==0.2.9-&gt;dwave-ocean-sdk) (2.0.1)
Requirement already satisfied: Deprecated&gt;=1.2.12 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from pyqubo==1.3.1-&gt;dwave-ocean-sdk) (1.2.13)
Requirement already satisfied: six&gt;=1.15.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from pyqubo==1.3.1-&gt;dwave-ocean-sdk) (1.16.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: wrapt&lt;2,&gt;=1.10 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from Deprecated&gt;=1.2.12-&gt;pyqubo==1.3.1-&gt;dwave-ocean-sdk) (1.14.1)
Requirement already satisfied: importlib-metadata&gt;=3.6.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from Flask&gt;=1.1.1-&gt;dwave-inspector==0.3.0-&gt;dwave-ocean-sdk) (5.0.0)
Requirement already satisfied: Werkzeug&gt;=2.2.2 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from Flask&gt;=1.1.1-&gt;dwave-inspector==0.3.0-&gt;dwave-ocean-sdk) (2.2.2)
Requirement already satisfied: itsdangerous&gt;=2.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from Flask&gt;=1.1.1-&gt;dwave-inspector==0.3.0-&gt;dwave-ocean-sdk) (2.1.2)
Requirement already satisfied: Jinja2&gt;=3.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from Flask&gt;=1.1.1-&gt;dwave-inspector==0.3.0-&gt;dwave-ocean-sdk) (3.0.3)
Requirement already satisfied: zipp&gt;=3.1.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from importlib-resources&gt;=3.2.0-&gt;dwave-inspector==0.3.0-&gt;dwave-ocean-sdk) (3.9.0)
Requirement already satisfied: typing-extensions&gt;=4.1.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from pydantic&gt;=1.7.3-&gt;dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (4.4.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from requests[socks]&gt;=2.18-&gt;dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (1.26.12)
Requirement already satisfied: charset-normalizer&lt;3,&gt;=2 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from requests[socks]&gt;=2.18-&gt;dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (2.1.1)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from requests[socks]&gt;=2.18-&gt;dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (2022.9.24)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from requests[socks]&gt;=2.18-&gt;dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (3.4)
Requirement already satisfied: PySocks!=1.5.7,&gt;=1.5.6 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from requests[socks]&gt;=2.18-&gt;dwave-cloud-client==0.10.3-&gt;dwave-ocean-sdk) (1.7.1)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: MarkupSafe&gt;=2.0 in /home/obm/Prog/miniconda3/envs/qml/lib/python3.8/site-packages (from Jinja2&gt;=3.0-&gt;Flask&gt;=1.1.1-&gt;dwave-inspector==0.3.0-&gt;dwave-ocean-sdk) (2.1.1)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> A new release of pip available: <span class=" -Color -Color-Red">22.3</span> -&gt; <span class=" -Color -Color-Green">22.3.1</span>
<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> To update, run: <span class=" -Color -Color-Green">pip install --upgrade pip</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dwave.system</span> <span class="kn">import</span> <span class="n">DWaveSampler</span><span class="p">,</span> <span class="n">EmbeddingComposite</span>
<span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;https://cloud.dwavesys.com/sapi&#39;</span>
<span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;***&#39;</span> <span class="c1"># Please relace with your own token</span>
</pre></div>
</div>
</div>
</div>
<p>Available annelers depend on the geographic location and machine’s online status. The list of solvers can be found on the D-Wave Leap dashboard.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampler_dw</span> <span class="o">=</span> <span class="n">DWaveSampler</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;Advantage_system4.1&#39;</span><span class="p">,</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
<span class="n">sampler_qa</span> <span class="o">=</span> <span class="n">EmbeddingComposite</span><span class="p">(</span><span class="n">sampler_dw</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">SolverAuthenticationError</span><span class="g g-Whitespace">                 </span>Traceback (most recent call last)
<span class="nn">Input In [43],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">sampler_dw</span> <span class="o">=</span> <span class="n">DWaveSampler</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;Advantage_system4.1&#39;</span><span class="p">,</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">sampler_qa</span> <span class="o">=</span> <span class="n">EmbeddingComposite</span><span class="p">(</span><span class="n">sampler_dw</span><span class="p">)</span>

<span class="nn">File ~/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/dwave/system/samplers/dwave_sampler.py:185,</span> in <span class="ni">DWaveSampler.__init__</span><span class="nt">(self, failover, retry_interval, **config)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_penalty</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">185</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_solver</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_penalty</span><span class="p">)</span>

<span class="nn">File ~/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/dwave/system/samplers/dwave_sampler.py:200,</span> in <span class="ni">DWaveSampler._get_solver</span><span class="nt">(self, refresh, penalty)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span> <span class="n">filters</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">default_solver</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span> <span class="n">order_by</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;order_by&#39;</span><span class="p">,</span> <span class="s1">&#39;avg_load&#39;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">200</span> <span class="n">solvers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_solvers</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">order_by</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> <span class="c1"># we now just need to de-prioritize penalized solvers</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span> <span class="n">solvers</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">solver</span><span class="p">:</span> <span class="n">penalty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="nn">File ~/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/dwave/cloud/events.py:105,</span> in <span class="ni">dispatches_events.__call__.&lt;locals&gt;.wrapped</span><span class="nt">(*pargs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span> <span class="n">dispatch_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">before_eventname</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">104</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">105</span>     <span class="n">rval</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">pargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">107</span>     <span class="n">dispatch_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">after_eventname</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>

<span class="nn">File ~/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/dwave/cloud/client/base.py:1173,</span> in <span class="ni">Client.get_solvers</span><span class="nt">(self, refresh, order_by, **filters)</span>
<span class="g g-Whitespace">   </span><span class="mi">1170</span>     <span class="n">query</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;name__eq&#39;</span><span class="p">]</span>
<span class="g g-Whitespace">   </span><span class="mi">1172</span> <span class="c1"># filter</span>
<span class="ne">-&gt; </span><span class="mi">1173</span> <span class="n">solvers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_solvers</span><span class="p">(</span><span class="o">**</span><span class="n">query</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1174</span> <span class="n">solvers</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solvers</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predicates</span><span class="p">)]</span>
<span class="g g-Whitespace">   </span><span class="mi">1176</span> <span class="c1"># sort: undefined (None) key values go last</span>

<span class="nn">File ~/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/dwave/cloud/utils.py:489,</span> in <span class="ni">cached.__call__.&lt;locals&gt;.wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">487</span>     <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">488</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">489</span>     <span class="n">val</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span>     <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">expires</span><span class="o">=</span><span class="n">now</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxage</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">492</span> <span class="k">return</span> <span class="n">val</span>

<span class="nn">File ~/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/dwave/cloud/client/base.py:807,</span> in <span class="ni">Client._fetch_solvers</span><span class="nt">(self, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">804</span>     <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;solvers/remote/&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">806</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">807</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">_sapi_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">808</span> <span class="k">except</span> <span class="n">SAPIError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">809</span>     <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exc</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>

<span class="nn">File ~/Prog/miniconda3/envs/qml/lib/python3.8/site-packages/dwave/cloud/client/base.py:1798,</span> in <span class="ni">Client._sapi_request</span><span class="nt">(meth, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1796</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1797</span>     <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1798</span>         <span class="k">raise</span> <span class="n">SolverAuthenticationError</span><span class="p">(</span><span class="n">error_code</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1800</span>     <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1801</span>         <span class="n">msg</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="ne">SolverAuthenticationError</span>: Invalid token or access denied
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampleset_qa</span> <span class="o">=</span> <span class="n">sampler_qa</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">qubo</span><span class="p">,</span><span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">records_qa</span> <span class="o">=</span> <span class="n">sampleset_qa</span><span class="o">.</span><span class="n">record</span>
<span class="nb">print</span><span class="p">(</span><span class="n">records_qa</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Above is the result of 10 samples from the solver.</p>
<p>First list items are the optimised combination of the stock items, 1 indicates the stock is included in the portfolio.</p>
<p>The second value is the energy state where the lowest number is the best solution. The number shows close to minus two hundred, because the offset value is not included.</p>
<p>Third number is the number of occurance of the solution. We have 10 reads and each read has unique stock selections.</p>
<p>The last number indicate “chain break” that the connection between qubits are broken then fixed by the software. Ideal soliution should have 0. chain break ratio.</p>
<p>Using records returned from the D-Wave solver, we can validate if the constraint terms are complied.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">portfolio_candidates_qa</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">num_stock_counts_qa</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">record_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">records_qa</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">record_len</span><span class="p">):</span>
  <span class="n">portfolio</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">num_stock_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records_qa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])):</span>
    <span class="k">if</span> <span class="n">records_qa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">portfolio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stocks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
      <span class="n">num_stock_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">portfolio_candidates_qa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span>
  <span class="n">num_stock_counts_qa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_stock_count</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_stock_counts_qa</span> <span class="c1"># number of stocks selected for the portfolio</span>
</pre></div>
</div>
</div>
</div>
<p>In our example, 4 of the 10 solutions fit the requirement. We may adjust the coeffient value by increasing the penalty.</p>
<p>Finally, we can select one best solution and display the sotck codes.
We will use 7th record where there was no chain break.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_portfolio_qa</span> <span class="o">=</span> <span class="n">portfolio_candidates_qa</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">best_portfolio_qa</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>D-Wave has hybrid solver that uses classical computer and quantum annealer.
The solver ‘hybrid_binary_quadratic_model_version2’ can have up to 1,000,000 variables.</p>
<p>To try the hybrid solver, we need to import LeapHybridSampler library. The difference from the quantum solver are:</p>
<ul class="simple">
<li><p>it does not require embed composite</p></li>
<li><p>only one sample record is returned (no num_reads parameter)</p></li>
<li><p>it consumes more QPU time (different conversion rate applies QPU: Hybrid 1:20)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dwave.system</span> <span class="kn">import</span> <span class="n">LeapHybridSampler</span>
<span class="n">sampler_dw_hybrid</span> <span class="o">=</span> <span class="n">LeapHybridSampler</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;hybrid_binary_quadratic_model_version2&#39;</span><span class="p">,</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
<span class="n">sampleset_qa_hybrid</span> <span class="o">=</span> <span class="n">sampler_dw_hybrid</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">qubo</span><span class="p">)</span>
<span class="n">records_qa_hybrid</span> <span class="o">=</span> <span class="n">sampleset_qa_hybrid</span><span class="o">.</span><span class="n">record</span>
<span class="nb">print</span><span class="p">(</span><span class="n">records_qa_hybrid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="sample-optimisation-results-from-a-simulated-quantum-annealing-solver">
<h1>5. Sample optimisation results from a simulated quantum annealing solver<a class="headerlink" href="#sample-optimisation-results-from-a-simulated-quantum-annealing-solver" title="Permalink to this heading">¶</a></h1>
<p>There is publicly available open source QA simulators provided by <a class="reference external" href="https://www.openjij.org/">OpenJIJ</a>. It can be used as an alternative the real quantum annerler. We can use the same QUBO prepared by PyQubo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install openjij
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openjij</span> <span class="kn">import</span> <span class="n">SQASampler</span>
<span class="n">sampler_jij</span> <span class="o">=</span> <span class="n">SQASampler</span><span class="p">()</span>
<span class="n">sampleset_sqa</span> <span class="o">=</span> <span class="n">sampler_jij</span><span class="o">.</span><span class="n">sample_qubo</span><span class="p">(</span><span class="n">qubo</span><span class="p">,</span><span class="n">num_reads</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">records_sqa</span> <span class="o">=</span> <span class="n">sampleset_sqa</span><span class="o">.</span><span class="n">record</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">records_sqa</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">portfolio_candidates_sqa</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">num_stock_counts_sqa</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">record_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">records_sqa</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">record_len</span><span class="p">):</span>
  <span class="n">portfolio</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">num_stock_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records_sqa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])):</span>
    <span class="k">if</span> <span class="n">records_sqa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">portfolio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stocks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
      <span class="n">num_stock_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">portfolio_candidates_sqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span>
  <span class="n">num_stock_counts_sqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_stock_count</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_stock_counts_sqa</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_portfolio_sqa</span> <span class="o">=</span> <span class="n">portfolio_candidates_sqa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">best_portfolio_sqa</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>#6. Evaluate the outcomes</p>
<p>We can select the best portfolio selection from QA and SQA samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">portfolio_qa</span> <span class="o">=</span> <span class="n">records_qa</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># best combination from QA hybdrid solver</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_qa</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">portfolio_sqa</span> <span class="o">=</span> <span class="n">records_sqa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># best combination from SQA hybdrid solver</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_sqa</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We compare the cost 1: increases the return rate.
The more return is achieved if the number is smaller than the other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h_cost1_qa</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">h_cost1_qa</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">portfolio_qa</span><span class="p">,</span><span class="n">actual_return_rate_mean_test</span><span class="p">)</span> <span class="c1"># maximisation problem. negative to make it minimisation problem</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h_cost1_qa</span><span class="p">)</span> <span class="c1"># return rate factor by QA</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h_cost1_sqa</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">h_cost1_sqa</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">portfolio_sqa</span><span class="p">,</span><span class="n">actual_return_rate_mean_test</span><span class="p">)</span> <span class="c1"># maximisation problem. negative to make it minimisation problem</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h_cost1_sqa</span><span class="p">)</span> <span class="c1"># return rate cost by SQA</span>
</pre></div>
</div>
</div>
</div>
<p>We also compare the cost 2: decrease the risk.
The more return is achieved if the number is smaller than the other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span><span class="o">=</span> <span class="mi">20</span>
<span class="n">h_cost2_qa</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">h_cost2_qa</span> <span class="o">+=</span> <span class="n">portfolio_qa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">portfolio_qa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean_test</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h_cost2_qa</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span><span class="o">=</span> <span class="mi">20</span>
<span class="n">h_cost2_sqa</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">h_cost2_sqa</span> <span class="o">+=</span> <span class="n">portfolio_sqa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">portfolio_sqa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean_test</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h_cost2_sqa</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can check the costs in case we selected all 20 stocks as benchmark.
The numbers will be divided by two for comparison.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">portfolio_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">h_cost1_all</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">h_cost1_all</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">portfolio_all</span><span class="p">,</span><span class="n">actual_return_rate_mean_test</span><span class="p">)</span> <span class="c1"># maximisation problem. negative to make it minimisation problem</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h_cost1_all</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span><span class="o">=</span> <span class="mi">20</span>
<span class="n">h_cost2_all</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">h_cost2_all</span> <span class="o">+=</span> <span class="n">portfolio_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">portfolio_all</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean_test</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h_cost2_all</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, the costs from Hybrid solver as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">portfolio_qa_hybrid</span> <span class="o">=</span> <span class="n">records_qa_hybrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># best combination from QA hybdrid solver</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_qa_hybrid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h_cost1_qa_hybrid</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">h_cost1_qa_hybrid</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">portfolio_qa_hybrid</span><span class="p">,</span><span class="n">actual_return_rate_mean_test</span><span class="p">)</span> <span class="c1"># maximisation problem. negative to make it minimisation problem</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h_cost1_qa_hybrid</span><span class="p">)</span> <span class="c1"># return rate factor by QA Hybrid Solver</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span><span class="o">=</span> <span class="mi">20</span>
<span class="n">h_cost2_qa_hybrid</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">h_cost2_qa_hybrid</span> <span class="o">+=</span> <span class="n">portfolio_qa_hybrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">portfolio_qa_hybrid</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">actual_return_rate_mean_test</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">actual_return_rate_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h_cost2_qa_hybrid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With compariso to the benchmark, we can observe sample reocrds from QA/SQA/Hybdrid solvers as:</p>
<ul class="simple">
<li><p>QA solver showed high-return but high-risks.</p></li>
<li><p>SQA solver recommended slightly lower return but minimum risk</p></li>
<li><p>Hybrid solver showed very similar costs for both return and risk as SQA</p></li>
</ul>
<p>Above is just a comparison of 1 sample record. We could analyse more sample records and visualsing the outcome. We could also tune hyper-parameters, like constraint coefficient.</p>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../../../_sources/courses/PHYS710/hands-on/hands-on-9/hands-on-9-book.ipynb.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright (CC BY 3.0) https://creativecommons.org/ .<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>